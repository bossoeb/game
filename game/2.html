<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>踩地雷遊戲</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 30px; }
        #board { display: inline-block; border: 2px solid #333; }
        .row { display: flex; }
        .cell {
            width: 32px; height: 32px;
            border: 1px solid #888;
            background: #ccc;
            font-size: 18px;
            text-align: center;
            line-height: 32px;
            cursor: pointer;
            user-select: none;
        }
        .cell.open { background: #eee; cursor: default; }
        .cell.mine { background: #f66; color: #fff; }
        .cell.flag { background: #ff0; }
        #restart { margin-top: 20px; font-size: 18px; }
        #mineCount { font-size: 20px; margin-bottom: 10px; }
        /* 不同數字顏色 */
        .num1 { color: #1976d2; }   /* 藍色 */
        .num2 { color: #388e3c; }   /* 綠色 */
        .num3 { color: #d32f2f; }   /* 紅色 */
        .num4 { color: #7b1fa2; }   /* 紫色 */
        .num5 { color: #ff8f00; }   /* 橘色 */
        .num6 { color: #00838f; }   /* 青色 */
        .num7 { color: #5d4037; }   /* 棕色 */
        .num8 { color: #616161; }   /* 灰色 */
    </style>
</head>
<body>
    <h1>踩地雷遊戲</h1>
    <p1>玩法：左鍵點擊格子開啟，右鍵或Shift+左鍵插旗。<br>
        開啟所有非地雷格子過關。<br>
        若開到地雷，將從第一關開始<br>
    <div id="mineCount"></div>
    <div id="board"></div>
    <div>
        <button id="nextBtn" onclick="goToNextLevel()" style="display:none;">進入下一關</button>
    </div>
    <p id="status"></p>
    <script>
        const ROWS = 10;
        const COLS = 10;
        const MINES = 20;

        let board = [];
        let mineBoard = [];
        let gameOver = false;
        let openedCount = 0;
        let flagCount = 0;
        let firstClick = true;

        function updateMineCount() {
            document.getElementById('mineCount').textContent = `剩餘地雷數：${MINES - flagCount}`;
        }

        function initGame() {
            board = [];
            mineBoard = [];
            gameOver = false;
            openedCount = 0;
            flagCount = 0;
            firstClick = true;
            document.getElementById('status').textContent = '';
            document.getElementById('nextBtn').style.display = "none";
            for (let r = 0; r < ROWS; r++) {
                board[r] = [];
                mineBoard[r] = [];
                for (let c = 0; c < COLS; c++) {
                    board[r][c] = { open: false, flag: false };
                    mineBoard[r][c] = 0;
                }
            }
            // 先不放地雷，等第一次點擊時再放
            updateMineCount();
            drawBoard();
        }

        function placeMines(firstR, firstC) {
            // 讓第一次點擊的格子和其周圍都不會有地雷
            let safe = [];
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    let nr = firstR + dr, nc = firstC + dc;
                    if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
                        safe.push(nr + ',' + nc);
                    }
                }
            }
            let minesPlaced = 0;
            while (minesPlaced < MINES) {
                let r = Math.floor(Math.random() * ROWS);
                let c = Math.floor(Math.random() * COLS);
                if (mineBoard[r][c] === 0 && !safe.includes(r + ',' + c)) {
                    mineBoard[r][c] = 1;
                    minesPlaced++;
                }
            }
        }

        function countMines(r, c) {
            let count = 0;
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    let nr = r + dr, nc = c + dc;
                    if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
                        if (mineBoard[nr][nc] === 1) count++;
                    }
                }
            }
            return count;
        }

        function openCell(r, c) {
            if (board[r][c].open || board[r][c].flag) return;

            // 第一次點擊時，確保點到的格子周圍地雷數為0
            if (firstClick) {
                firstClick = false;
                // 反覆嘗試直到這格周圍沒地雷
                let tryCount = 0;
                do {
                    // 清空地雷
                    for (let rr = 0; rr < ROWS; rr++) {
                        for (let cc = 0; cc < COLS; cc++) {
                            mineBoard[rr][cc] = 0;
                        }
                    }
                    placeMines(r, c);
                    tryCount++;
                    // 最多嘗試100次避免極端情況
                    if (tryCount > 100) break;
                } while (countMines(r, c) !== 0);
            }

            board[r][c].open = true;
            openedCount++;
            if (mineBoard[r][c] === 1) {
                gameOver = true;
                revealMines();
                document.getElementById('status').textContent = '遊戲結束！你踩到地雷了！';
                document.getElementById('nextBtn').style.display = "none";
                drawBoard();
                setTimeout(function() {
                    window.location.href = '1.html';
                }, 1500);
                return;
            }
            const count = countMines(r, c);
            if (count === 0) {
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        let nr = r + dr, nc = c + dc;
                        if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
                            if (!board[nr][nc].open) openCell(nr, nc);
                        }
                    }
                }
            }
            if (checkWin()) {
                gameOver = true;
                document.getElementById('status').textContent = '恭喜你過關！';
                document.getElementById('nextBtn').style.display = "inline-block";
            }
            drawBoard();
        }

        function toggleFlag(r, c) {
            if (board[r][c].open) return;
            if (board[r][c].flag) {
                board[r][c].flag = false;
                flagCount--;
            } else {
                if (flagCount < MINES) {
                    board[r][c].flag = true;
                    flagCount++;
                }
            }
            drawBoard();
        }

        function revealMines() {
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (mineBoard[r][c] === 1) board[r][c].open = true;
                }
            }
        }

        function checkWin() {
            let safeCells = ROWS * COLS - MINES;
            let opened = 0;
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (board[r][c].open && mineBoard[r][c] === 0) opened++;
                }
            }
            return opened === safeCells;
        }

        function goToNextLevel() {
            window.location.href = '3.html';
        }

        // 點擊已開啟的數字格時，若周圍旗子數等於數字，則自動開啟周圍未開啟且未插旗的格子
        function openAroundIfFlagEnough(r, c) {
            if (!board[r][c].open) return;
            const number = countMines(r, c);
            if (number === 0) return;
            let flagAround = 0;
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    let nr = r + dr, nc = c + dc;
                    if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
                        if (board[nr][nc].flag) flagAround++;
                    }
                }
            }
            if (flagAround === number) {
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        let nr = r + dr, nc = c + dc;
                        if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
                            if (!board[nr][nc].open && !board[nr][nc].flag) {
                                openCell(nr, nc);
                            }
                        }
                    }
                }
            }
        }

        function drawBoard() {
            const boardDiv = document.getElementById('board');
            boardDiv.innerHTML = '';
            for (let r = 0; r < ROWS; r++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                for (let c = 0; c < COLS; c++) {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'cell';
                    if (board[r][c].open) {
                        cellDiv.classList.add('open');
                        if (mineBoard[r][c] === 1) {
                            cellDiv.classList.add('mine');
                            cellDiv.textContent = '💣';
                        } else {
                            const count = countMines(r, c);
                            if (count > 0) {
                                cellDiv.textContent = count;
                                cellDiv.classList.add('num' + count);
                                cellDiv.style.cursor = "pointer";
                                cellDiv.onclick = function(e) {
                                    if (gameOver) return;
                                    openAroundIfFlagEnough(r, c);
                                };
                            }
                        }
                    } else if (board[r][c].flag) {
                        cellDiv.classList.add('flag');
                        cellDiv.textContent = '🚩';
                        cellDiv.onclick = function(e) {
                            if (gameOver) return;
                            if (e.shiftKey) {
                                toggleFlag(r, c);
                            } else {
                                openCell(r, c);
                            }
                        };
                    } else {
                        cellDiv.onclick = function(e) {
                            if (gameOver) return;
                            if (e.shiftKey) {
                                toggleFlag(r, c);
                            } else {
                                openCell(r, c);
                            }
                        };
                    }
                    cellDiv.oncontextmenu = function(e) {
                        e.preventDefault();
                        if (!gameOver) toggleFlag(r, c);
                    };
                    rowDiv.appendChild(cellDiv);
                }
                boardDiv.appendChild(rowDiv);
            }
            updateMineCount();
        }

        window.onload = initGame;
    </script>
</body>
</html>